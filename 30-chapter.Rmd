# Chapter 30 - The PhenoFlex model

In this chapter, the PhenoFlex model is fitted to bloom data of Roter Boskoop apples and its performance is evaluated using predicted and observed bloom dates.


```{r}
library(chillR)
library(tidyverse)
```

**weather → hourly temps**

```{r}
CKA_weather <- read_tab("data/TMaxTMin1958-2019_patched.csv")
hourtemps <- stack_hourly_temps(CKA_weather, latitude = 50.6)
```

**Phenology (First bloom)**

```{r}
Roter_first <- read_tab("data/Roter_Boskoop_bloom_1958_2019.csv") %>%
  select(Pheno_year, First_bloom) %>%
  mutate(
    Year  = as.numeric(substr(First_bloom, 1, 4)),
    Month = as.numeric(substr(First_bloom, 5, 6)),
    Day   = as.numeric(substr(First_bloom, 7, 8))
  ) %>%
  make_JDay() %>%
  select(Pheno_year, JDay) %>%
  rename(Year = Pheno_year, pheno = JDay) %>%
  filter(!is.na(pheno)) %>%
  arrange(Year)

Roter_first <- Roter_first %>% filter(Year >= 1959)

years_roter <- sort(unique(Roter_first$Year))
```

**Build SeasonList**

```{r}
SeasonList <- genSeasonList(hourtemps$hourtemps,
                            mrange = c(8, 6),
                            years  = years_roter)

stopifnot(length(SeasonList) == nrow(Roter_first))
```

**Parameters + bounds**

```{r}
par <-   c(40, 190, 0.5, 25, 3372.8,  9900.3, 6319.5,
           5.939917e13,  4, 36,  4,  1.60)

upper <- c(41, 200, 1.0, 30, 4000.0, 10000.0, 7000.0,
           6.e13, 10, 40, 10, 50.00)

lower <- c(38, 180, 0.1, 0 , 3000.0,  9000.0, 6000.0,
           5.e13,  0,  0,  0,  0.05)
```

## Parameterize PhenoFlex for Roter Boskoop

**Parameterize the PhenoFlex model for `Roter Boskoop’ apples.**

```{r}
Fit_res <- phenologyFitter(
  par.guess  = par,
  modelfn    = PhenoFlex_GDHwrapper,
  bloomJDays = Roter_first$pheno,
  SeasonList = SeasonList,
  lower      = lower,
  upper      = upper,
  control    = list(
    smooth = FALSE,
    verbose = FALSE,
    maxit = 1000,
    nb.stop.improvement = 5
  )
)

Roter_par <- Fit_res$par
stopifnot(length(Roter_par) == 12)

write.csv(Roter_par,
          "data/PhenoFlex_parameters_Roter_Boskoop.csv",
          row.names = FALSE)

```


## Predicted vs. observed bloom dates

**Produce plots of predicted vs. observed bloom dates and distribution of prediction errors**

```{r}
Roter_PhenoFlex_predictions <- Roter_first
Roter_PhenoFlex_predictions$predicted <- NA_real_

for (y in 1:nrow(Roter_PhenoFlex_predictions)) {
  Roter_PhenoFlex_predictions$predicted[y] <-
    PhenoFlex_GDHwrapper(SeasonList[[y]], Roter_par)
}

Roter_PhenoFlex_predictions$Error <-
  Roter_PhenoFlex_predictions$predicted -
  Roter_PhenoFlex_predictions$pheno

```

**Predicted vs observed**

```{r}
ggplot(Roter_PhenoFlex_predictions,
       aes(x = pheno, y = predicted)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  theme_bw(base_size = 15) +
  xlab("Observed bloom date (Day of the year)") +
  ylab("Predicted bloom date (Day of the year)") +
  ggtitle("Roter Boskoop – Predicted vs. observed bloom dates")
```

**Error distribution**

```{r}
ggplot(Roter_PhenoFlex_predictions,
       aes(Error)) +
  geom_histogram(bins = 20) +
  theme_bw(base_size = 15) +
  xlab("Prediction error (days)") +
  ggtitle("Roter Boskoop – Distribution of prediction errors")
```

## Model performance metrics

**Compute the model performance metrics RMSEP, mean error and mean absolute error.**

```{r}
RMSEP(Roter_PhenoFlex_predictions$predicted,
      Roter_PhenoFlex_predictions$pheno)

mean(Roter_PhenoFlex_predictions$Error)

mean(abs(Roter_PhenoFlex_predictions$Error))
```

