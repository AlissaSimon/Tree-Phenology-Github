# Chapter 14 — Historic temperature scenarios

In this chapter, observed temperature records are extended with simulated scenarios to analyze past temperature patterns and their effects on chill accumulation.

```{r}
library(chillR)
library(tidyverse)

Goe_weather <- weather_final
```


## Creating historic temperature scenarios

**For the location you chose for previous exercises, produce historic temperature scenarios representing several years of the historic record (your choice).**

```{r}
Temp <- temperature_generation(
  Goe_weather,
  years = c(1990, 2005),
  sim_years = c(2001, 2100)
)

Temp <- Temp[[1]]
Temp$Data_source <- "simulated"

Temperature_scenarios <- Goe_weather %>%
  filter(Year %in% 1990:2005) %>%
  mutate(Data_source = "observed") %>%
  rbind(
    Temp[, c('Year','Month','Day','Tmin','Tmax','Data_source')]
  ) %>%
  mutate(Date = as.Date(ISOdate(2000, Month, Day)))

```

## Chill accumulation under historic scenarios

**Produce chill distributions for these scenarios and plot them and calculating winter chill for observed and simulated data**

```{r}
library(ggplot2)
library(dplyr)
library(chillR)

chill_observed <- Temperature_scenarios %>%
  filter(Data_source == "observed") %>%
  stack_hourly_temps(latitude = 47.6) %>%
  chilling(Start_JDay = 91, End_JDay = 120)

chill_simulated <- Temperature_scenarios %>%
  filter(Data_source == "simulated") %>%
  stack_hourly_temps(latitude = 47.6) %>%
  chilling(Start_JDay = 91, End_JDay = 120)

chill_comparison_full <- cbind(chill_observed, Data_source = "observed") %>%
  rbind(cbind(chill_simulated, Data_source = "simulated")) %>%
  filter(Perc_complete == 100)
```

**Comparison of temperature patterns**

```{r}
# Tmin plot
ggplot(data = Temperature_scenarios, aes(x = Date, y = Tmin)) +
  geom_smooth(aes(colour = factor(Year)), show.legend = FALSE) +
  facet_wrap(vars(Data_source)) +
  theme_bw(base_size = 20) +
  scale_x_date(date_labels = "%b")

# Tmax plot
ggplot(data = Temperature_scenarios, aes(x = Date, y = Tmax)) +
  geom_smooth(aes(colour = factor(Year)), show.legend = FALSE) +
  facet_wrap(vars(Data_source)) +
  theme_bw(base_size = 20) +
  scale_x_date(date_labels = "%b")
```

**Chill distribution analysis**

```{r}
ggplot(chill_comparison_full, aes(x = Chill_portions)) +
  geom_histogram(binwidth = 1, aes(fill = Data_source)) +
  theme_bw(base_size = 20) +
  labs(fill = "Data source") +
  xlab("Chill accumulation (Chill Portions)") +
  ylab("Frequency")
```

**Cumulative distribution of chill accumulation**

```{r}
chill_sim <- chill_comparison_full %>%
  filter(Data_source == "simulated")

ggplot(chill_sim, aes(x = Chill_portions)) +
  stat_ecdf(geom = "step", lwd = 1.5, col = "blue") +
  ylab("Cumulative probability") +
  xlab("Chill accumulation (Chill Portions)") +
  scale_y_continuous(breaks = seq(0,1,0.1)) +
  theme_bw(base_size = 20)
```

**Saving scenario and chill data**

```{r}
write.csv(Temperature_scenarios,
file = "data_Güttingen/Temperatures_ch14.csv",
row.names = FALSE)

write.csv(chill_comparison_full,
file = "data_Güttingen/Chill_distributions_ch14.csv",
row.names = FALSE)
```